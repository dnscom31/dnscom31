<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KG CHEM 종합검진 안내문</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header>
    <h1 class="title">KG CHEM 종합검진 안내문</h1>
    <button id="adminButton" class="admin-button">관리자</button>
  </header>
  <main>
    <section id="mandatory-checks">
      <h2>인적사항</h2>
      <!-- action 속성을 제거했습니다 -->
      <form id="submissionForm" method="post">
        <ol>
          <li>성 명</li>
          <textarea name="name" placeholder="성함을 입력해 주세요" rows="1" cols="40"></textarea>

          <li>연락처</li>
          <textarea name="contact" placeholder="연락처를 입력하세요" rows="1" cols="40"></textarea>

          <li>이메일</li>
          <textarea name="email" placeholder="이메일을 입력하세요" rows="1" cols="40"></textarea>

          <li>주  소</li>
          <textarea name="address" placeholder="주소를 입력하세요" rows="1" cols="40"></textarea>

          <li>검진희망일</li>
          <!-- 날짜와 시간을 분리하여 입력 -->
          <input type="date" name="preferred_date_date">
          <select name="preferred_date_time">
            <option value="07:00">07:00</option>
            <option value="07:30">07:30</option>
            <option value="08:00">08:00</option>
            <option value="08:30">08:30</option>
            <option value="09:00">09:00</option>
            <option value="09:30">09:30</option>
            <option value="10:00">10:00</option>
            <option value="10:30">10:30</option>
            <option value="11:00">11:00</option>
            <option value="11:30">11:30</option>
            <option value="12:00">12:00</option>
          </select>
        </ol>
        <h2>필수 확인 사항</h2>
        <ol>
          <li>복용약 <span style="font-size: 0.8em;">(아스피린은 7일전 부터 복용 금지 입니다.)</span></li>
          <textarea name="medications" placeholder="복용중인 약물을 입력하세요" rows="2" cols="100"></textarea>

          <li>대장 내시경 시 용종 제거 동의 (비용 별도)</li>
          <label>
            <input type="radio" name="polyp_removal" value="yes"> O
          </label>
          <label>
            <input type="radio" name="polyp_removal" value="no"> X
          </label>

          <li>대장 내시경 후 2주 이내 비행 예정 여부</li>
          <label>
            <input type="radio" name="flight_within_2weeks" value="yes"> O
          </label>
          <label>
            <input type="radio" name="flight_within_2weeks" value="no"> X
          </label>

          <li>MRI 검사 시 문제가 될 수 있는 폐쇄공포증 및 금속 인공물, 인공 판막 등 장착 여부</li>
          <textarea name="mri_issues" placeholder="상세 내용을 입력하세요" rows="2" cols="100"></textarea>
        </ol>

        <!-- 검진 유형 선택 추가 -->
        <h2>검진 유형 선택</h2>
        <div id="checkup-type">
          <label><input type="radio" name="checkup_type" value="기본형"> 기본형</label>
          <label><input type="radio" name="checkup_type" value="소화기형"> 소화기형</label>
          <label><input type="radio" name="checkup_type" value="MRI형"> MRI형</label>
        </div>

        <section id="a-group">
          <h2>A그룹 <span style="font-size: 0.8em;">4가지 선택 가능</span></h2>
          <ul>
            <li>[01]갑상선초음파 <input type="checkbox" class="a-group-checkbox" name="a_group_selections" value="갑상선초음파"></li>
            <li>[02]경동맥초음파 <input type="checkbox" class="a-group-checkbox" name="a_group_selections" value="경동맥초음파"></li>
            <li>[03]뇌CT <input type="checkbox" class="a-group-checkbox" name="a_group_selections" value="뇌CT"></li>
            <li>[04]폐CT <input type="checkbox" class="a-group-checkbox" name="a_group_selections" value="폐CT"></li>
            <li>[05]요추CT <input type="checkbox" class="a-group-checkbox" name="a_group_selections" value="요추CT"></li>
            <li>[06]경추CT <input type="checkbox" class="a-group-checkbox" name="a_group_selections" value="경추CT"></li>
            <li>[07]심장MDCT <input type="checkbox" class="a-group-checkbox" name="a_group_selections" value="심장MDCT"></li>
            <li>[08]복부비만CT <input type="checkbox" class="a-group-checkbox" name="a_group_selections" value="복부비만CT"></li>
            <li>[09]골다공증QCT + 비타민D <input type="checkbox" class="a-group-checkbox" name="a_group_selections" value="골다공증QCT + 비타민D"></li>
            <li>[10]혈관협착도ABI <input type="checkbox" class="a-group-checkbox" name="a_group_selections" value="혈관협착도ABI"></li>
            <li>[11](여)경질초음파 <input type="checkbox" class="a-group-checkbox" name="a_group_selections" value="경질초음파"></li>
            <li>[12](여)액상 자궁경보세포진 <input type="checkbox" class="a-group-checkbox" name="a_group_selections" value="액상 자궁경보세포진"></li>
            <li>[13](여)_(혈액)마스토체크_유방암 <input type="checkbox" class="a-group-checkbox" name="a_group_selections" value="마스토체크_유방암"></li>
            <li>[14](여)HPV바이러스 <input type="checkbox" class="a-group-checkbox" name="a_group_selections" value="HPV바이러스"></li>
            <li>[15](혈액)NK뷰키트 <input type="checkbox" class="a-group-checkbox" name="a_group_selections" value="NK뷰키트"></li>
            <li>[16](여)여성호르몬(Estradiol+FSH) <input type="checkbox" class="a-group-checkbox" name="a_group_selections" value="여성호르몬(Estradiol+FSH)"></li>
            <li>[17](남)남성호르몬(Testosterone+Free Testosterone) <input type="checkbox" class="a-group-checkbox" name="a_group_selections" value="남성호르몬(Testosterone+Free Testosterone)"></li>
            <li>[18](혈액)스마트암_난소암 <input type="checkbox" class="a-group-checkbox" name="a_group_selections" value="스마트암_난소암"></li>
            <li>[19](혈액) 스마트암_폐암 <input type="checkbox" class="a-group-checkbox" name="a_group_selections" value="스마트암_폐암"></li>
            <li>[20](혈액) 스마트암_간암 <input type="checkbox" class="a-group-checkbox" name="a_group_selections" value="스마트암_간암"></li>
            <li>[21](혈액) 스마트암_대장암 <input type="checkbox" class="a-group-checkbox" name="a_group_selections" value="스마트암_대장암"></li>
            <li>[22](혈액) 스마트암_췌장암 <input type="checkbox" class="a-group-checkbox" name="a_group_selections" value="스마트암_췌장암"></li>
          </ul>
        </section>
        <section id="b-group">
          <h2>B그룹</h2>
          <ul>
            <li>[가]심장초음파 <input type="checkbox" class="b-group-checkbox" name="b_group_selections" value="심장초음파"></li>
            <li>[나]유방초음파 <input type="checkbox" class="b-group-checkbox" name="b_group_selections" value="유방초음파"></li>
            <li>[다]알츠온치매검사 <input type="checkbox" class="b-group-checkbox" name="b_group_selections" value="알츠온치매검사"></li>
            <li>[라](혈액) 알레르기, 91종 <input type="checkbox" class="b-group-checkbox" name="b_group_selections" value="알레르기, 91종"></li>
          </ul>
        </section>
        <section id="c-group">
          <h2>C그룹</h2>
          <ul>
            <li>[A]뇌MRA + 뇌MRI <input type="checkbox" class="c-group-checkbox" name="c_group_selections" value="뇌MRA + 뇌MRI"></li>
            <li>[B]경추MRI <input type="checkbox" class="c-group-checkbox" name="c_group_selections" value="경추MRI"></li>
            <li>[C]요추MRI <input type="checkbox" class="c-group-checkbox" name="c_group_selections" value="요추MRI"></li>
            <li>[D]스마트암검사(6)7종_혈액 <input type="checkbox" class="c-group-checkbox" name="c_group_selections" value="스마트암검사(6)7종_혈액"></li>
          </ul>
        </section>
        <section id="vip-checkup">
          <h2>검진유형안내</h2>
          <p>기본형 : 공통항목(90여종) + A그룹 선택 4가지 </p>
          <p>소화기형 : 공통항목(90여종) + A그룹 선택 2가지 + B그룹 선택 1가지</p>
          <p>MRI형 : 공통항목(90여종) + C그룹 선택 1가지</p>
        </section>
        <section id="additional-info">
          <h2>기타안내</h2>
          <ul>
            <li>위수면 희망시 별도 본인부담 없음</li>
            <li>위 또는 대장 내시경 용종제거 및 조직검사 비용 별도</li>
            <li>내시경, 심장초음파, MRI 선택시 예약필수</li>
            <li>A그룹 2가지 미선택시 B그룹 1가지 선택 가능</li>
            <li>A그룹 추가시 항목당 7만원 추가</li>
          </ul>
        </section>
        <button type="submit">제출</button>
      </form>
    </section>
  </main>
  <footer>
    <p>© 뉴고려병원</p>
  </footer>

  <script>
    document.getElementById('adminButton').addEventListener('click', () => {
      window.location.href = '/login.html';
    });

    document.addEventListener('DOMContentLoaded', () => {
      const aGroupCheckboxes = document.querySelectorAll('.a-group-checkbox');
      const bGroupCheckboxes = document.querySelectorAll('.b-group-checkbox');
      const cGroupCheckboxes = document.querySelectorAll('.c-group-checkbox');
      let maxASelection = 0;
      let maxBSelection = 0;
      let maxCSelection = 0;

      // 초기에는 모든 그룹의 체크박스를 비활성화 및 선택 해제
      function disableAllGroups() {
        aGroupCheckboxes.forEach(cb => { cb.disabled = true; cb.checked = false; });
        bGroupCheckboxes.forEach(cb => { cb.disabled = true; cb.checked = false; });
        cGroupCheckboxes.forEach(cb => { cb.disabled = true; cb.checked = false; });
      }
      disableAllGroups();

      // 검진 유형 선택에 따른 그룹 활성화, 최대 선택 개수 업데이트 및 기존 선택 해제 처리
      function updateCheckupTypeSelection() {
        const selectedType = document.querySelector('input[name="checkup_type"]:checked');
        if (!selectedType) return;
        const type = selectedType.value;

        // 기존 선택된 체크박스 모두 해제
        aGroupCheckboxes.forEach(cb => cb.checked = false);
        bGroupCheckboxes.forEach(cb => cb.checked = false);
        cGroupCheckboxes.forEach(cb => cb.checked = false);

        if (type === "기본형") {
          maxASelection = 4;
          maxBSelection = 0;
          maxCSelection = 0;
          document.querySelector('#a-group h2').innerHTML = 'A그룹 <span style="font-size: 0.8em;">4가지 선택 가능</span>';
          document.querySelector('#b-group h2').textContent = 'B그룹 (선택 불가능)';
          document.querySelector('#c-group h2').textContent = 'C그룹 (선택 불가능)';
        } else if (type === "소화기형") {
          maxASelection = 2;
          maxBSelection = 1;
          maxCSelection = 0;
          document.querySelector('#a-group h2').innerHTML = 'A그룹 <span style="font-size: 0.8em;">2가지 선택 가능</span>';
          document.querySelector('#b-group h2').innerHTML = 'B그룹 <span style="font-size: 0.8em;">1가지 선택 가능</span>';
          document.querySelector('#c-group h2').textContent = 'C그룹 (선택 불가능)';
        } else if (type === "MRI형") {
          maxASelection = 0;
          maxBSelection = 0;
          maxCSelection = 1;
          document.querySelector('#a-group h2').textContent = 'A그룹 (선택 불가능)';
          document.querySelector('#b-group h2').textContent = 'B그룹 (선택 불가능)';
          document.querySelector('#c-group h2').innerHTML = 'C그룹 <span style="font-size: 0.8em;">1가지 선택 가능</span>';
        }

        // 각 그룹의 체크박스 활성화/비활성화 처리
        aGroupCheckboxes.forEach(cb => {
          cb.disabled = (maxASelection === 0);
        });
        bGroupCheckboxes.forEach(cb => {
          cb.disabled = (maxBSelection === 0);
        });
        cGroupCheckboxes.forEach(cb => {
          cb.disabled = (maxCSelection === 0);
        });
      }

      // 검진 유형 radio 버튼 변화에 따른 이벤트 처리
      const checkupTypeRadios = document.querySelectorAll('input[name="checkup_type"]');
      checkupTypeRadios.forEach(radio => {
        radio.addEventListener('change', updateCheckupTypeSelection);
      });

      // A그룹 체크박스 선택 제한 처리
      aGroupCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          const checkedCount = document.querySelectorAll('#a-group input[type="checkbox"]:checked').length;
          if (checkedCount > maxASelection) {
            checkbox.checked = false;
            alert(`A그룹은 최대 ${maxASelection}가지 항목만 선택 가능합니다.`);
          }
        });
      });

      // B그룹 체크박스 선택 제한 처리
      bGroupCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          const checkedCount = document.querySelectorAll('#b-group input[type="checkbox"]:checked').length;
          if (checkedCount > maxBSelection) {
            checkbox.checked = false;
            alert(`B그룹은 최대 ${maxBSelection}가지 항목만 선택 가능합니다.`);
          }
        });
      });

      // C그룹 체크박스 선택 제한 처리
      cGroupCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          const checkedCount = document.querySelectorAll('#c-group input[type="checkbox"]:checked').length;
          if (checkedCount > maxCSelection) {
            checkbox.checked = false;
            alert(`C그룹은 최대 ${maxCSelection}가지 항목만 선택 가능합니다.`);
          }
        });
      });

      // 폼 제출 이벤트 처리 (검증 포함 및 fetch API 사용)
      document.getElementById('submissionForm').addEventListener('submit', (event) => {
        event.preventDefault();
        console.log("폼 제출 이벤트 발생");

        // 인적사항 필수 입력 검증
        const name = document.querySelector('textarea[name="name"]').value.trim();
        const contact = document.querySelector('textarea[name="contact"]').value.trim();
        const email = document.querySelector('textarea[name="email"]').value.trim();
        const address = document.querySelector('textarea[name="address"]').value.trim();
        if (!name || !contact || !email || !address) {
          alert("인적사항(성명, 연락처, 이메일, 주소)을 모두 입력해 주세요.");
          return;
        }

        // 검진희망일 필수 입력 검증 (날짜와 시간)
        const preferredDateDate = document.querySelector('input[name="preferred_date_date"]').value;
        const preferredDateTime = document.querySelector('select[name="preferred_date_time"]').value;
        if (!preferredDateDate || !preferredDateTime) {
          alert("검진희망일의 날짜와 시간을 모두 선택해 주세요.");
          return;
        }
        const preferred_date = preferredDateDate + "T" + preferredDateTime;

        // 필수 확인 사항 검증
        const medications = document.querySelector('textarea[name="medications"]').value.trim();
        if (!medications) {
          alert("필수 확인 사항인 복용약 내용을 입력해 주세요.");
          return;
        }

        // 검진 유형 선택 검증
        const selectedType = document.querySelector('input[name="checkup_type"]:checked');
        if (!selectedType) {
          alert("검진 유형을 선택해 주세요.");
          return;
        }
        const checkupType = selectedType.value;

        // 그룹별 선택 개수 검증
        let validGroupSelection = true;
        if (checkupType === "기본형") {
          const countA = document.querySelectorAll('#a-group input[type="checkbox"]:checked').length;
          if (countA !== 4) {
            validGroupSelection = false;
            alert("기본형은 A그룹에서 정확히 4개 항목을 선택해야 합니다.");
          }
        } else if (checkupType === "소화기형") {
          const countA = document.querySelectorAll('#a-group input[type="checkbox"]:checked').length;
          const countB = document.querySelectorAll('#b-group input[type="checkbox"]:checked').length;
          if (countA !== 2 || countB !== 1) {
            validGroupSelection = false;
            alert("소화기형은 A그룹에서 정확히 2개, B그룹에서 정확히 1개 항목을 선택해야 합니다.");
          }
        } else if (checkupType === "MRI형") {
          const countC = document.querySelectorAll('#c-group input[type="checkbox"]:checked').length;
          if (countC !== 1) {
            validGroupSelection = false;
            alert("MRI형은 C그룹에서 정확히 1개 항목을 선택해야 합니다.");
          }
        }
        if (!validGroupSelection) return;

        // 폼 데이터 객체 구성 (FormData를 사용하지 않고 수동으로 값 추출)
        const data = {
          name: name,
          contact: contact,
          email: email,
          address: address,
          preferred_date: preferred_date,
          medications: medications,
          polyp_removal: document.querySelector('input[name="polyp_removal"]:checked')?.value,
          flight_within_2weeks: document.querySelector('input[name="flight_within_2weeks"]:checked')?.value,
          mri_issues: document.querySelector('textarea[name="mri_issues"]').value.trim(),
          checkup_type: checkupType,
          a_group_selections: Array.from(document.querySelectorAll('input[name="a_group_selections"]:checked')).map(cb => cb.value),
          b_group_selections: Array.from(document.querySelectorAll('input[name="b_group_selections"]:checked')).map(cb => cb.value),
          c_group_selections: Array.from(document.querySelectorAll('input[name="c_group_selections"]:checked')).map(cb => cb.value)
        };

        console.log("제출 데이터:", data);

        fetch('/api/submit', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        })
        .then(response => {
          console.log("응답 상태:", response.status);
          return response.text();
        })
        .then(result => {
          console.log("서버 응답:", result);
          alert(result);
        })
        .catch(error => {
          console.error('Error:', error);
        });
      });
    });
  </script>
</body>
</html>
